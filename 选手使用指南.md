# SUPCON AdventureX 智能工厂仿真 - 选手使用指南

## 一、比赛概览

欢迎参加 SUPCON AdventureX 黑客松比赛！你们将要开发一个 AI Agent 来控制和优化一个智能工厂的运行。

### 核心目标
开发一个 AI Agent，通过 MQTT 协议接收工厂状态信息，做出智能决策，发送控制命令来：
- 📦 高效完成生产订单
- 🔧 快速诊断并修复设备故障  
- 🔋 合理管理 AGV 充电和调度
- 💰 控制生产成本，提高效率

### 评分标准（满分 100 分）
- **生产效率** (40分): 订单完成率、生产周期、设备利用率
- **成本控制** (30分): 一次通过率、总生产成本
- **AGV效率** (30分): 充电策略、能效比、利用率

## 二、快速开始

### 1. 环境准备

```bash
# 安装 uv 包管理器
curl -LsSf https://astral.sh/uv/install.sh | sh

# 克隆项目
git clone <repository_url>
cd 25-SUPCON-AdventureX-Hackthon

# 安装依赖
uv sync
```

### 2. 启动仿真系统

#### 新的多终端操作模式（推荐）

为了提供更好的用户体验，我们将仿真系统的提示信息和操作控制分离到不同的终端窗口。

请打开 **3个终端窗口**，分别运行：

**终端 1 - 主仿真程序**
```bash
uv run run_simulation.py
# 或禁用故障系统
uv run run_simulation.py --no-faults
```

**终端 2 - 监控终端**
```bash
uv run monitor_simulation.py
```
- 实时显示仿真状态、故障警报、KPI指标
- 定期显示游戏提示，帮助优化策略

**终端 3 - 控制终端**
```bash
uv run control_simulation.py
```
- 提供友好的交互式菜单
- 控制AGV移动、装载、卸载、充电

#### 传统单终端模式
```bash
# 启动并开启手动控制菜单（已废弃，建议使用多终端模式）
uv run run_simulation.py --menu
```

### 3. 体验交互式测试

```bash
# 运行交互式体验，了解系统运作
uv run test/test_interactive_factory.py
```

## 三、工厂系统说明

### 生产流程

```
原料仓库 → [AGV运输] → 工站A → [传送带] → 工站B → [传送带] → 工站C → [传送带] → 质检站 → [AGV运输] → 成品仓库
```

特殊流程：P3产品需要在工站C后返回工站B进行二次加工

### 设备配置

| 设备 | ID | 功能 | 缓冲区 |
|------|-----|------|--------|
| 工站A | StationA | 初级加工 | 3个位置 |
| 工站B | StationB | 精密加工 | 3个位置 |
| 工站C | StationC | 测试 | 3个位置 |
| 质检站 | QualityCheck | 质量检测 | 输入2个，输出3个 |
| AGV_1 | AGV_1 | 下方运输（y<20） | 载重2个 |
| AGV_2 | AGV_2 | 上方运输（y>20） | 载重2个 |

### 产品类型

- **P1** (60%): 标准产品，常规流程
- **P2** (30%): 高精度产品，处理时间较长
- **P3** (10%): 复杂产品，需要二次加工

## 四、MQTT 通信接口

### 连接配置

```python
MQTT_BROKER_HOST = "localhost"
MQTT_BROKER_PORT = 1883
CLIENT_ID = "agent_player_001"  # 自定义你的 Agent ID
```

### 订阅主题（接收信息）

#### 1. 设备状态（每10秒更新）
```
# 工站状态
NLDF1/line1/station/{station_id}/status
NLDF1/line1/conveyor/{conveyor_id}/status
NLDF1/line1/resource/{agv_id}/status
NLDF1/line1/warehouse/{warehouse_id}/status
```

状态消息示例：
```json
{
  "device_id": "StationA",
  "status": "processing",  // idle, processing, block, fault
  "buffer_level": 2,
  "buffer_capacity": 3,
  "current_product": "PROD_001_P1",
  "processing_time_left": 15.5,
  "symptom": null  // 故障时显示症状
}
```

#### 2. 警报主题
```
# 缓冲区满警报
NLDF1/line1/alerts/buffer_full

# AGV低电量警报
NLDF1/line1/alerts/agv_battery_low
```

#### 3. 订单信息
```
# 新订单
NLDF1/line1/orders/new
```

订单消息示例：
```json
{
  "order_id": "ORDER_001",
  "product_type": "P1",
  "quantity": 3,
  "priority": "high",
  "deadline": 1234567890.123,
  "created_at": 1234567000.123
}
```

#### 4. KPI 更新（每10秒）
```
NLDF1/line1/kpi/update
```

### 发布主题（发送命令）

#### 命令主题
```
NLDF1/line1/agent/commands
```

#### 命令格式

1. **AGV 移动**
```json
{
  "command_id": "cmd_001",
  "action": "move",
  "target": "AGV_1",
  "params": {
    "destination_id": "P3"  // P0-P10 路径点
  }
}
```

2. **AGV 装载**
```json
{
  "action": "load",
  "target": "AGV_1", 
  "params": {
    "source_station_id": "StationA"
  }
}
```

3. **AGV 卸载**
```json
{
  "action": "unload",
  "target": "AGV_1",
  "params": {
    "target_station_id": "StationB"
  }
}
```

4. **AGV 充电**
```json
{
  "action": "charge",
  "target": "AGV_1",
  "params": {}
}
```

## 五、AGV 路径点说明

### AGV_1 路径点（下方路线）
- P0: [5, 15] - 原料仓库
- P1: [12, 15] - 工站A
- P3: [32, 15] - 工站B
- P5: [52, 15] - 工站C
- P7: [72, 15] - 质检站（输入）
- P8: [80, 15] - 质检站（输出）
- P9: [95, 15] - 成品仓库
- P10: [10, 10] - 充电站

### AGV_2 路径点（上方路线）
- P0: [5, 25] - 原料仓库
- P1: [12, 25] - 工站A
- P3: [32, 25] - 工站B
- P5: [52, 25] - 工站C
- P7: [72, 25] - 质检站（输入）
- P8: [80, 25] - 质检站（输出）
- P9: [95, 25] - 成品仓库
- P10: [10, 30] - 充电站

## 六、故障诊断系统

### 故障类型与症状

工厂设备会随机出现故障，需要正确诊断并修复：

| 故障类型 | 可能原因 | 正确修复命令 |
|---------|---------|-------------|
| station_vibration | 轴承磨损/螺栓松动 | replace_bearing/tighten_bolts |
| precision_degradation | 刀具钝化/校准偏移 | replace_tool/recalibrate |
| agv_path_blocked | 临时障碍/定位故障 | reroute_agv/reboot_device |
| agv_battery_drain | 电池老化/高负载任务 | force_charge/optimize_schedule |
| efficiency_anomaly | 软件过热/润滑不足 | reduce_frequency/add_lubricant |

### 诊断流程

1. 监听故障警报
2. 分析故障症状
3. 发送正确的修复命令
4. 正确诊断获得基础修复时间，错误诊断会有时间惩罚

## 七、AGV 电量管理

### 电量消耗
- 移动：0.1%/米
- 装载/卸载：0.5%/次
- 静止：0%

### 充电机制
- 充电速度：3.33%/秒（30秒充满）
- 低电量阈值：5%（强制返航充电）
- 建议在 20% 时主动充电避免惩罚

## 八、开发建议

### 1. 基础框架示例

```python
import json
import paho.mqtt.client as mqtt
from typing import Dict, List

class FactoryAgent:
    def __init__(self):
        self.client = mqtt.Client("agent_player_001")
        self.factory_state = {}
        self.active_orders = []
        
    def on_connect(self, client, userdata, flags, rc):
        # 订阅所有需要的主题
        client.subscribe("NLDF1/line1/station/+/status")
        client.subscribe("NLDF1/line1/resource/+/status")
        client.subscribe("NLDF1/line1/orders/new")
        client.subscribe("NLDF1/line1/alerts/+")
        
    def on_message(self, client, userdata, msg):
        topic = msg.topic
        data = json.loads(msg.payload.decode())
        
        # 更新状态
        if "/status" in topic:
            self.update_device_status(topic, data)
        elif "/orders/new" in topic:
            self.handle_new_order(data)
        elif "/alerts/" in topic:
            self.handle_alert(topic, data)
            
    def send_command(self, action: str, target: str, params: dict):
        command = {
            "action": action,
            "target": target,
            "params": params
        }
        self.client.publish("NLDF1/line1/agent/commands", json.dumps(command))
```

### 2. 策略建议

#### 初级策略
1. 监控所有设备状态
2. 当原料仓库有材料时，派 AGV 运输到工站A
3. 监控缓冲区，避免溢出
4. AGV 电量低于 20% 时主动充电

#### 进阶策略
1. 根据订单优先级调度生产
2. 预测设备故障，提前维护
3. 优化 AGV 路径，减少空载行驶
4. 动态调整生产节奏，平衡效率和成本

#### 高级策略
1. 实现多订单并行处理
2. 建立故障诊断知识库
3. 使用强化学习优化决策
4. 预测性维护和资源分配

### 3. 调试技巧

```bash
# 监控所有 MQTT 消息
mosquitto_sub -h localhost -t '#' -v

# 手动发送测试命令
mosquitto_pub -h localhost -t 'NLDF1/line1/agent/commands' -m '{"action":"move","target":"AGV_1","params":{"destination_id":"P1"}}'
```

## 九、常见问题

### Q: 如何处理缓冲区满的情况？
A: 监听 buffer_full 警报，及时派 AGV 清空缓冲区或暂停上游生产。

### Q: AGV 充电时机如何选择？
A: 建议在订单间隙或生产低峰期主动充电，避免被动充电的惩罚。

### Q: 如何提高质检通过率？
A: 确保产品按正确流程生产，P3产品必须完成二次加工。

### Q: 故障诊断总是失败怎么办？
A: 仔细分析故障症状，参考故障诊断手册，建立症状到修复命令的映射。

## 十、提交要求

1. **Docker 镜像**：将你的 Agent 打包成 Docker 镜像
2. **文档**：包含架构说明和使用方法
3. **源代码**：完整的 Agent 实现代码

### Dockerfile 示例

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

CMD ["python", "agent.py"]
```

## 祝你在比赛中取得优异成绩！

如有问题，请联系技术支持团队。记住：高效、智能、鲁棒是获胜的关键！